# SKILL: Silver Engineer Extension Development

## Trigger
Use this skill when working on the `silver-engineer` VS Code extension — adding features,
fixing bugs, refactoring, or continuing development across machines.

---

## Project Identity

| Field | Value |
|---|---|
| Extension ID | `silver-engineer.silver-engineer` |
| Publisher | `silver-engineer` |
| Display name | Silver Engineer |
| Entry point | `src/extension.ts` → bundles to `dist/extension.js` |
| Activation | `onStartupFinished` (zero startup impact) |
| Min VS Code | `^1.95.0` |
| Node target | Node 20 / ESNext |
| Bundler | esbuild (dual bundle: extension CJS + webview IIFE) |

---

## Repository Layout

```
silver-engineer/
├── src/
│   ├── extension.ts          # activate() / deactivate() / runBackgroundStartup()
│   ├── types.ts              # SilverServices interface (circular-import breaker)
│   ├── secretManager.ts      # OS keychain wrapper (vscode.SecretStorage)
│   ├── notificationManager.ts# Daily summary popup
│   ├── chatParticipant.ts    # @silver chat participant
│   ├── mcpServer.ts          # Embedded HTTP MCP server
│   ├── toolRegistry.ts       # HITL tool invocation (Strategy + Command)
│   ├── graphStore.ts         # graphology knowledge graph
│   ├── vectorStore.ts        # vectra LocalIndex + TF-IDF fallback
│   ├── fileWatcher.ts        # watches .vscode/silver-skills/*.md
│   ├── skills/
│   │   ├── loader.ts         # progressive skill loading
│   │   └── templates/        # built-in SKILL.md files
│   └── webview/
│       ├── panel.ts          # DashboardPanel singleton
│       ├── entry.ts          # canvas force-layout (browser bundle)
│       └── index.html        # webview shell
├── scripts/
│   ├── generate-icon.js      # pure-Node PNG generator (no deps)
│   └── obfuscate.js          # javascript-obfuscator light profile
├── assets/
│   ├── icon.png              # 128×128 (generated by generate-icon.js)
│   └── icon-sidebar.svg
├── .vscode/
│   ├── launch.json           # F5 = "Run Extension" (builds first)
│   ├── tasks.json            # build + watch tasks
│   └── silver-skills/        # user skill overrides live here
├── .github/
│   └── workflows/ci.yml      # lint → build → scan → package → artifact
├── esbuild.config.js         # build pipeline
├── package.json
├── tsconfig.json
└── .vscodeignore             # whitelist: package.json README LICENSE assets/ dist/ (no maps)
```

---

## Architecture

### Service Graph
```
extension.ts (activate)
  ├── SecretManager          (OS keychain)
  ├── GraphStore             (graphology KG, autosaves every 60s)
  ├── VectorStore            (vectra LocalIndex)
  ├── SkillsLoader           (builtin templates + .vscode/silver-skills/)
  ├── McpServerManager       ←─── ToolInvoker callback injected from ToolRegistry
  ├── ToolRegistry           ←─── receives partial SilverServices, completes the circle
  └── FileWatcher            (reloads skills on .md create/change/delete)
```

### Circular Import Fix
`src/types.ts` holds the `SilverServices` interface. `ToolRegistry` is constructed with a
partial object, then `partial.tools = tools` completes the reference:
```typescript
const partial = { secrets, graph, vectors, skills, mcp } as SilverServices;
const tools   = new ToolRegistry(context, partial);
partial.tools  = tools;
mcp.setToolInvoker(async (toolName, args) => {
  const result = await tools.invokeWithConfirmation(toolName, args);
  return result?.output;
});
```

### Chat Participant ID Rule
**Critical:** `chatParticipants[].id` in `package.json` must equal `{publisher}.{name}` from
the top-level manifest — i.e. `silver-engineer.silver-engineer`. The `name` field (`silver`)
is what users type as `@silver`. Mismatch → "No activated agent" error.

### MCP Provider Registration
Must declare in `package.json`:
```json
"mcpServerDefinitionProviders": [
  { "id": "silver-engineer.mcp", "label": "Silver Engineer MCP" }
]
```
Without this → `Background startup error: MCP configuration providers must be registered...`

### Runtime Assets (encoder.json / vocab.bpe)
`gpt-3-encoder` (used by vectra) does `fs.readFileSync(path.join(__dirname, './encoder.json'))`.
When bundled, `__dirname` = `dist/`. So `esbuild.config.js` calls `copyRuntimeAssets()` which
copies both files from `node_modules/gpt-3-encoder/` to `dist/` on every build.

---

## Built-in Tools (ToolRegistry)

| Tool name | What it does |
|---|---|
| `silver_commit_code` | Stage + conventional commit via git CLI |
| `silver_update_jira` | Update Jira issue (status / comment / assignee) via REST |
| `silver_generate_component` | Scaffold source file from nearest SKILL template |
| `silver_recall` | Query vector store + KG for relevant context |

All tools go through `invokeWithConfirmation()` — shows Allow/Cancel modal before executing.

---

## Slash Commands (@silver)

| Command | Behaviour |
|---|---|
| `/summary` | LLM summary of KG context (colleagues, tech stack, work items) |
| `/skills` | List all loaded skills (builtin + user) |
| `/graph` | Open Webview Knowledge Graph visualiser |
| `/workflow` | Run agentic loop (Think→Try→Observe, max 10 iterations) |

---

## Key Config Settings

```json
"silverEngineer.jiraBaseUrl": "https://your-company.atlassian.net",
"silverEngineer.jiraProjectKey": "PROJ",
"silverEngineer.maxAgentLoopIterations": 10,
"silverEngineer.enableDailyNotification": true,
"silverEngineer.notificationTime": "09:00",
"silverEngineer.graphScanDepth": 3
```

Secrets (stored in OS keychain via `SecretStorage`):
- `SILVER_JIRA_API_TOKEN`
- `SILVER_JIRA_EMAIL`
- `SILVER_GITHUB_PAT` (replace with Gerrit REST token at company)
- `SILVER_CUSTOM_API_TOKEN`

Configure via: **Ctrl+Shift+P** → `Silver Engineer: Configure API Credentials`

---

## Build Commands

```powershell
# Development build (with sourcemaps, copies encoder.json + vocab.bpe to dist/)
node esbuild.config.js

# Production build (minified, no sourcemaps)
node esbuild.config.js --production

# Watch mode (rebuilds on save, also copies runtime assets once)
node esbuild.config.js --watch

# Type-check only
npx tsc --noEmit

# Package VSIX
npx vsce package --no-dependencies --allow-missing-repository

# Install locally
code --install-extension silver-engineer-0.1.0.vsix --force
```

---

## Common Errors & Fixes

| Error | Cause | Fix |
|---|---|---|
| `ENOENT: encoder.json` | Runtime asset not in dist/ | Run `node esbuild.config.js` (copies automatically) |
| `No activated agent with id "silver-engineer.silver"` | Participant ID mismatch | `package.json` id must be `silver-engineer.silver-engineer`; `src/chatParticipant.ts` `PARTICIPANT_ID` must match |
| `MCP configuration providers must be registered` | Missing contributes declaration | Add `mcpServerDefinitionProviders` array to `package.json` contributes |
| `TS2339: Property 'System' does not exist` | `LanguageModelChatMessage.System` not in stable API | Use `.User('[SYSTEM] ...')` pattern instead |
| ESLint peer conflict | `@typescript-eslint` needs eslint `^8` | Pin `"eslint": "^8.56.0"` in package.json |

---

## Adding a New Tool

1. Create a `SilverTool` implementation in `src/toolRegistry.ts`:
```typescript
const myTool: SilverTool = {
  name: 'silver_my_tool',
  description: 'What it does',
  inputSchema: { type: 'object', properties: { param: { type: 'string' } }, required: ['param'] },
  async invoke(input, svc) {
    // use svc.graph, svc.vectors, svc.secrets, etc.
    return { output: 'result text' };
  },
};
```
2. Add to `this.tools` map in `registerAll()`.
3. Declare in `package.json` under `contributes.languageModelTools`.

---

## Adding a User Skill

Drop a `.md` file in `.vscode/silver-skills/`:
```markdown
---
name: my-skill
description: Short description (used for relevance matching)
triggers: ["keyword1", "keyword2"]
---
# Skill Title
## Context
...
## Steps
1. ...
```
FileWatcher picks it up automatically — no restart needed.

---

## Gerrit Integration (Company-Specific Replacement for GitHub)

Replace `silver_commit_code` tool to call Gerrit REST API instead of GitHub PAT:
```typescript
// In toolRegistry.ts, replace commitCodeTool.invoke:
const token = await svc.secrets.get('SILVER_GERRIT_TOKEN');
const response = await fetch(`${gerritBaseUrl}/a/changes/`, {
  method: 'POST',
  headers: { 'Authorization': `Basic ${btoa(`:${token}`)}`, 'Content-Type': 'application/json' },
  body: JSON.stringify({ project: 'repo', subject: commitMsg, branch: 'main' }),
});
```
Add `SILVER_GERRIT_TOKEN` and `SILVER_GERRIT_URL` to `SECRET_KEYS` in `secretManager.ts`.

---

## VSCode API Stability Notes

- `vscode.chat.createChatParticipant` — stable since 1.90
- `vscode.lm.selectChatModels` — stable since 1.90
- `vscode.lm.computeEmbeddings` — **proposed API** (check availability at runtime)
- `vscode.lm.registerMcpServerDefinitionProvider` — **proposed API** (check at runtime)
- `vscode.SecretStorage` — stable since 1.53
- All proposed API calls are wrapped in `typeof x === 'function'` guards
